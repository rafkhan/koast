angular.module("koast",["koast-user","koast-resource"]).factory("koast",["_koastUser","_koastResourceGetter","$log",function(t,e,n){"use strict";var r={},o=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return r.user=t,o.forEach(function(t){r[t]=e[t]}),r.init=function(e){n.info("Initializing koast."),t.init(e)},r}]),angular.module("koast-persona",[]).factory("_koastPersona",["$http","$q","$interval","$location","$log",function(t,e,n,r,o){"use strict";function i(){var t,r=window.document,o=r.getElementsByTagName("head")[0],i=r.createElement("script"),a=e.defer();return i.type="text/javascript",i.async=!0,i.src="https://login.persona.org/include.js",o.appendChild(i),t=n(function(){window.navigator.id&&(a.resolve(),n.cancel(t))},50),a.promise}function a(e){o.debug("verifyAssertion:");var n=r.absUrl().split("/").slice(0,3).join("/")+"/",i={assertion:e,audience:n};o.info("audience:",n);var a={timeout:5e3};return t.post("/auth/browserid",i,a).then(function(t){return o.debug("Response:",t),t.data}).then(null,function(t){throw"object"==typeof t&&t.headers?(o.error("Persona verification timed out."),new Error("Persona verification timed out.")):(o.error("Error verifying Persona assertion:",t.toString()),o.error(t.stack),t)})}var u={},s=!1,c=e.defer();return u.initiateSignIn=function(t){t||(t={}),o.debug("signIn"),s=!0,navigator.id.request({siteName:t.siteTitle,oncancel:function(){o.info("Persona login cancelled by user.")}})},u.initiateSignOut=function(){s=!0,navigator.id.logout()},u.init=function(t){return i().then(function(){o.debug("navigator.id.watch added"),navigator.id.watch({loggedInUser:null,onlogin:function(e){s&&a(e).then(function(e){t.onSignIn(e)},o.error)},onlogout:function(){s&&t.onSignOut()},onready:function(){c.resolve()}})}).then(null,o.error),c.promise},u.whenReady=function(){return c.promise},u}]),angular.module("koast-resource",["koast-user"]).factory("_KoastServerHelper",["_koastUser",function(t){"use strict";var e={};return e.addAuthHeaders=function(e){t.isSignedIn&&(e["koast-auth-token"]=t.meta.authToken,e["koast-auth-token-timestamp"]=t.meta.timestamp,e["koast-user"]=angular.toJson(t.data))},e}]).factory("_KoastResource",["_KoastServerHelper","$q","$http","$log",function(t,e,n,r){"use strict";function o(t,e){var n=this;return _.keys(e.data).forEach(function(t){n[t]=e.data[t]}),Object.defineProperty(this,"can",{get:function(){return e.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return t}}),this}return o.prototype.save=function(){var e=this._endpoint.makeGetUrl(this),r={};return t.addAuthHeaders(r),n.put(e,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var e=this._endpoint.makeGetUrl(this);r.debug("delete url:",e);var o={};return t.addAuthHeaders(o),n.delete(e,{headers:o})},o}]).factory("_KoastEndpoint",[function(){"use strict";function t(t,e,n){var r=this;r.prefix=t,r.handle=e,r.template=n}function e(t,e){return e?t.replace(/:([-_a-zA-Z]*)/g,function(t,n){var r=e[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return e[n]}):""}return t.prototype.makePostUrl=function(){return this.prefix+this.handle},t.prototype.makeGetUrl=function(t){return this.makePostUrl()+"/"+e(this.template,t)},t}]).factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log",function(t,e,n,r,o,i){"use strict";function a(n,a,u,s){var c=o.defer(),f=d[n],l={};if(s=s||{},!f)throw new Error("Unknown endpoint: "+n);return e.addAuthHeaders(l),r.get(f.makeGetUrl(a),{params:u,headers:l}).success(function(e){var n=[];if(e.forEach(function(e){var r=new t(f,e);n.push(r)}),s.singular){if(0===n.length)return null;n.length>1&&i.warn("Expected a singular resource, got "+n.length),c.resolve(n[0])}else c.resolve(n)}).error(function(t){c.reject(t)}),c.promise}function u(t,n,i){var a=o.defer(),u=d[t],s={};if(i=i||{},!u)throw new Error("Unknown endpoint: "+t);return e.addAuthHeaders(s),r.post(u.makePostUrl(),n,{headers:s}).success(function(t){a.resolve(t)}).error(function(t){a.reject(t)}),a.promise}var s,c={},d={};return c.setApiUriPrefix=function(t){s=t},c.getResource=function(t,e){return a(t,e,null,{singular:!0})},c.createResource=function(t,e){return u(t,e).then(function(t){return t},i.error)},c.queryForResources=function(t,e){return a(t,null,e)},c.addEndpoint=function(t,e){var r=new n(s,t,e);if(d[t])throw new Error("An endpoint with this handle was already defined: "+t);d[t]=r},c}]),angular.module("koast-user",[]).factory("_koastOauth",["$window","$location","$log",function(t,e){"use strict";function n(t,e){return o+"auth/"+t+"?next="+encodeURIComponent(e)}var r={},o="http://127.0.0.1:3000";return r.initiateAuthentication=function(r){var o=n(r,e.absUrl());t.location.replace(o)},r.setBaseUrl=function(t){o=t},r}]).factory("_koastUser",["_koastOauth","$log","$timeout","$http","$window",function(t,e,n,r,o){"use strict";function i(t){return r.get(t||"/auth/user").then(function(t){var e=t.data;return e.isAuthenticated&&(s.data=e.data,s.meta=e.meta),s.isAuthenticated=e.isAuthenticated,e.isAuthenticated}).then(function(t){return e.debug("isAuthenticated?",t),t&&!s.meta.isRegistered&&a?n(a,0).then(function(){return t}):(s.isReady=!0,t)}).then(null,e.error)}var a,u,s={isAuthenticated:!1,data:{},meta:{}};return s.initiateOauthAuthentication=function(e){t.initiateAuthentication(e)},s.logout=function(t){return r.post("/auth/logout").then(function(e){if("Ok"!==e.data)throw new Error("Failed to logout.");o.location.replace(t||"/")}).then(null,function(t){throw e.error(t),t})},s.register=function(t){return r.put("/auth/user",t).then(function(){return i()})},s.checkUsernameAvailability=function(t){return r.get("/auth/usernameAvailable",{params:{username:t}}).then(function(t){return"true"===t.data}).then(null,e.error)},s.setRegistrationHanler=function(t){a=t},s.getStatusPromise=function(){return u||(u=i()),u},s.init=function(e){return t.setBaseUrl(e.baseUrl),s.getStatusPromise()},s}]);