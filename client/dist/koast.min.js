angular.module("koast",["koast-user","koast-resource"]).factory("koast",["_koastUser","_koastResourceGetter","$log",function(t,e,n){"use strict";var r={},o=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return r.user=t,o.forEach(function(t){r[t]=e[t]}),r.init=function(e){n.info("Initializing koast."),t.init(e)},r}]),angular.module("koast-persona",[]).factory("_koastPersona",["$http","$q","$interval","$location","$log",function(t,e,n,r,o){"use strict";function a(){var t,r=window.document,o=r.getElementsByTagName("head")[0],a=r.createElement("script"),i=e.defer();return a.type="text/javascript",a.async=!0,a.src="https://login.persona.org/include.js",o.appendChild(a),t=n(function(){window.navigator.id&&(i.resolve(),n.cancel(t))},50),i.promise}function i(e){o.debug("verifyAssertion:");var n=r.absUrl().split("/").slice(0,3).join("/")+"/",a={assertion:e,audience:n};o.info("audience:",n);var i={timeout:5e3};return t.post("/auth/browserid",a,i).then(function(t){return o.debug("Response:",t),t.data}).then(null,function(t){throw"object"==typeof t&&t.headers?(o.error("Persona verification timed out."),new Error("Persona verification timed out.")):(o.error("Error verifying Persona assertion:",t.toString()),o.error(t.stack),t)})}var u={},s=!1,c=e.defer();return u.initiateSignIn=function(t){t||(t={}),o.debug("signIn"),s=!0,navigator.id.request({siteName:t.siteTitle,oncancel:function(){o.info("Persona login cancelled by user.")}})},u.initiateSignOut=function(){s=!0,navigator.id.logout()},u.init=function(t){return a().then(function(){o.debug("navigator.id.watch added"),navigator.id.watch({loggedInUser:null,onlogin:function(e){s&&i(e).then(function(e){t.onSignIn(e)},o.error)},onlogout:function(){s&&t.onSignOut()},onready:function(){c.resolve()}})}).then(null,o.error),c.promise},u.whenReady=function(){return c.promise},u}]),angular.module("koast-resource",["koast-user"]).factory("_KoastServerHelper",["_koastUser",function(t){"use strict";var e={};return e.addAuthHeaders=function(e){t.isSignedIn&&(e["koast-auth-token"]=t.meta.authToken,e["koast-auth-token-timestamp"]=t.meta.timestamp,e["koast-user"]=angular.toJson(t.data))},e}]).factory("_KoastResource",["_KoastServerHelper","$q","$http","$log",function(t,e,n,r){"use strict";function o(t,e){var n=this;return _.keys(e.data).forEach(function(t){n[t]=e.data[t]}),Object.defineProperty(this,"can",{get:function(){return e.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return t}}),this}return o.prototype.save=function(){var e=this._endpoint.makeGetUrl(this),r={};return t.addAuthHeaders(r),n.put(e,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var e=this._endpoint.makeGetUrl(this);r.debug("delete url:",e);var o={};return t.addAuthHeaders(o),n.delete(e,{headers:o})},o}]).factory("_KoastEndpoint",[function(){"use strict";function t(t,e,n){var r=this;r.prefix=t,r.handle=e,r.template=n}function e(t,e){return e?t.replace(/:([-_a-zA-Z]*)/g,function(t,n){var r=e[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return e[n]}):""}return t.prototype.makePostUrl=function(){return this.prefix+this.handle},t.prototype.makeGetUrl=function(t){return this.makePostUrl()+"/"+e(this.template,t)},t}]).factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log",function(t,e,n,r,o,a){"use strict";function i(n,i,u,s){var c=o.defer(),l=d[n],f={};if(s=s||{},!l)throw new Error("Unknown endpoint: "+n);return e.addAuthHeaders(f),r.get(l.makeGetUrl(i),{params:u,headers:f}).success(function(e){var n=[];if(e.forEach(function(e){var r=new t(l,e);n.push(r)}),s.singular){if(0===n.length)return null;n.length>1&&a.warn("Expected a singular resource, got "+n.length),c.resolve(n[0])}else c.resolve(n)}).error(function(t){c.reject(t)}),c.promise}function u(t,n,a){var i=o.defer(),u=d[t],s={};if(a=a||{},!u)throw new Error("Unknown endpoint: "+t);return e.addAuthHeaders(s),r.post(u.makePostUrl(),n,{headers:s}).success(function(t){i.resolve(t)}).error(function(t){i.reject(t)}),i.promise}var s,c={},d={};return c.setApiUriPrefix=function(t){s=t},c.getResource=function(t,e){return i(t,e,null,{singular:!0})},c.createResource=function(t,e){return u(t,e).then(function(t){return console.log(t),t},a.error)},c.queryForResources=function(t,e){return i(t,null,e)},c.addEndpoint=function(t,e){var r=new n(s,t,e);if(d[t])throw new Error("An endpoint with this handle was already defined: "+t);d[t]=r},c}]),angular.module("koast-user",[]).factory("_koastOauth",["$window","$location","$log",function(t,e){"use strict";function n(t,e){return o+"/auth/"+t+"?next="+encodeURIComponent(e)}var r={},o=e.absUrl().split("/").slice(0,3).join("/")+"/";return r.initiateAuthentication=function(r){var o=n(r,e.absUrl());t.location.replace(o)},r.setBaseUrl=function(t){o=t},r.makeRequestURL=function(t){return o+t},r}]).factory("_koastUser",["_koastOauth","$log","$timeout","$http","$window","$q",function(t,e,n,r,o){"use strict";function a(t){var e=t.data;return e.isAuthenticated&&(l.data=e.data,l.meta=e.meta),l.isAuthenticated=e.isAuthenticated,e.isAuthenticated}function i(t){return t.data&&t.data.username?(l.data=t.data,l.isAuthenticated=!0,l.meta=t.meta):(l.data={},l.isAuthenticated=!1),l.isAuthenticated}function u(t){return e.debug("isAuthenticated?",t),t&&!l.meta.isRegistered&&c?n(c,0).then(function(){return t}):(l.isReady=!0,t)}function s(n){return r.get(n||t.makeRequestURL("/auth/user")).then(a).then(u).then(null,e.error)}var c,d,l={isAuthenticated:!1,data:{},meta:{}};return l.initiateOauthAuthentication=function(e){t.initiateAuthentication(e)},l.logout=function(n){return r.post(t.makeRequestURL("/auth/logout")).then(function(t){if("Ok"!==t.data)throw new Error("Failed to logout.");o.location.replace(n||"/")}).then(null,function(t){throw e.error(t),t})},l.loginLocal=function(n){e.debug("Login:",n.username);var o={params:{username:n.username,password:n.password}};return r.post(t.makeRequestURL("/auth/login"),{},o).then(i)},l.registerSocial=function(e){return r.put(t.makeRequestURL("/auth/user"),e).then(function(){return s()})},l.registerLocal=function(e){return r.post(t.makeRequestURL("/auth/user"),e)},l.checkUsernameAvailability=function(n){return r.get(t.makeRequestURL("/auth/usernameAvailable"),{params:{username:n}}).then(function(t){return"true"===t.data}).then(null,e.error)},l.setRegistrationHanler=function(t){c=t},l.getStatusPromise=function(){return d||(d=s()),d},l.init=function(e){return t.setBaseUrl(e.baseUrl),l.getStatusPromise()},l}]);